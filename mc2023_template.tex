%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  This is a sample LaTeX input file for your contribution to
%  the M&C2023 topical meeting.
%
%  Please use it as a template for your full paper
%    Accompanying/related file(s) include:
%       1. Document class/format file: mc2023.cls
%       2. Sample PDF/Postscript Figure: figure.pdf,figure.ps
%       3. A PDF file showing the desired appearance: mc2023_template.pdf
%       4. cites.sty and citesort.sty that might be needed by some users
%    Direct questions about these files to: buijsa@mcmaster.ca
%    Originals provided by brantley1@llnl.gov
%
%    Notes:
%      (1) You can use the "dvips" utility to convert .dvi
%          files to PostScript.  Then, use either Acrobat
%          Distiller or "ps2pdf" to convert to PDF format.
%      (2) Different versions of LaTeX have been observed to
%          shift the page down, causing improper margins.
%          If this occurs, adjust the "topmargin" value in the
%          mc2023.cls file to achieve the proper margins.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[letterpaper]{mc2023}
%
%  various packages that you may wish to activate for usage
\usepackage{tabls}
\usepackage{cites}
\usepackage{epsf}
\usepackage{appendix}
\usepackage{ragged2e}
\usepackage[top=1in, bottom=1in, left=1in, right=1in]{geometry}
\usepackage{enumitem}
\setlist[itemize]{leftmargin=*}
\usepackage{caption}
\captionsetup{width=1.0\textwidth,font={bf,normalsize},skip=0.3cm,within=none,justification=centering}

% ELIMINATING WHITESPACE
\setlength{\belowcaptionskip}{-15pt}
\setlength{\abovedisplayskip}{4pt}
\setlength{\belowdisplayskip}{4pt}


\usepackage{xcolor}
\usepackage[colorlinks = true, linkcolor = black, urlcolor  = black, citecolor = black]{hyperref}
\usepackage{float} % for [H] option in figures

% GLOSSARIES
\usepackage[acronym,nomain,nonumberlist,nogroupskip,nopostdot]{glossaries} % for glossary of acronyms
\usepackage{siunitx}
\setacronymstyle{long-short}
\loadglsentries{glossary}
\makeglossaries
\renewcommand*{\glstextformat}[1]{\textcolor{black}{#1}} % make glossary color black

% Lewis custom commands
\input{lewis_custom_commands}

\title{Verification of the Cardinal Multiphysics Solver for 1-D Coupled\\
Heat Transfer and Neutron Transport}

\raggedbottom % TODO this or vfill
\author{%
  % FIRST AUTHORS
  %
  \textbf{L.I.~Gross$^1$, A.J.~Novak$^2$, P.Shriwise$^2$, and P.P.H.~Wilson$^1$}\\
  $^1$University of Wisconsin -- Madison  \\
  1500 Engineering Drive, Madison, WI 53706 \vspace{6pt}\\
  $^2$Argonne National Laboratory \\
  9700 S Cass Avenue, Lemont, IL 60439\vspace{6pt} \\
  \url{ligross@wisc.edu}, \url{anovak@anl.gov}, \url{pshriwise@anl.gov} \url{paul.wilson@wisc.edu}
}
%
% Insert authors' names and short version of title in lines below
%
\newcommand{\authorHead}{Gross et al.}
\newcommand{\shortTitle}{Cardinal Multiphysics Analytical Benchmark Verification}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   BEGIN DOCUMENT
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}
\maketitle
\justify
\parskip 6pt plus 1 pt minus 1 pt

\begin{abstract}
  Cardinal is a multiphysics software tool that couples OpenMC Monte Carlo transport and NekRS \gls{cfd} to the \gls{moose}.
  In this work, we verify Cardinal for coupled heat conduction and neutron transport using a 1-D analytic solution from previous
  work by the Naval Nuclear Laboratories. This numerical benchmark includes $S_2$ transport, Doppler-broadened cross-sections,
  thermal conduction and expansion, and convective boundary conditions. The goals of this work are to verify Cardinal's basic
  multiphysics modeling capabilities for coupled neutronics and heat conduction, while serving as a computational ``test bed''
  for assessing the performance of various multiphysics coupling strategies and algorithms. The key numerical metrics to match
  from the analytical benchmark are the temperature and flux distributions. Using the analytical solution for temperature, an
  $L_{2}$ error norm was computed for each mesh size. The error showed linear convergence with a slope of $-0.9979$ on a plot
  of $log(N)$ vs $log(\epsilon)$, where $N$ is the number of mesh elements and $\epsilon$ is the error norm. The ratio of the
  computed to analytical flux in each mesh element shows agreement between $0.997$ and $1.004$ for all the data points in
  each mesh. The eigenvalue $k_{eff}$ also agreed well with the benchmark's $0.29557$ for each mesh size. These results increase
  confidence in the fidelity of Cardinal's multi-physics modeling capabilities.
\end{abstract}
\vspace{6pt}
\keywords{Cardinal, MOOSE, OpenMC, multiphysics, verification}

\section{INTRODUCTION}
\label{sec:intro}
With recent advancements in methods, software, and computing, high-fidelity multiphysics \gls{ms} is becoming an important
component of the nuclear engineer's ``toolbox.'' These high-fidelity models substitute excessively pessimistic safety factors
with predictive science. This can reduce uncertainty in analyses, enabling tighter margins to realize improved economics
and licensing certainty. However, analytical benchmarks and comparison to experimental data are required to assess the stability,
convergence, and predictive capability of these high-fidelity models for reactor design and analysis.

Cardinal \cite{novak2022_cardinal} is an open-source code  that couples OpenMC \cite{openmc} Monte Carlo particle transport and
NekRS \gls{cfd} to \gls{moose} \cite{lindsay2022moose}. This coupling brings high-fidelity multiphysics feedback to the \gls{moose}
``ecosystem.'' Cardinal couples OpenMC and NekRS to \gls{moose} simulations by copying data between the internal code data structures
(e.g. a vector of tally results in OpenMC) and a \texttt{MooseMesh}, or the unstructured mesh class in \gls{moose}. \gls{moose}'s
mesh-to-mesh interpolation system then communicates between the \texttt{MooseMesh} ``mirror'' of the external code's solution and an
arbitrary coupled \gls{moose} application in the form of boundary conditions (such as for conjugate heat transfer with NekRS) or
source terms (such as for volumetric heating with OpenMC). Convergence is obtained with Picard iteration.

For coupled neutronics-thermal-fluid simulations with OpenMC, each Picard iteration consists of several steps: 1)~a \gls{moose}
application (e.g. BISON, Pronghorn, NekRS via Cardinal, ...) solves for temperatures and densities; 2)~Cardinal transfers
temperatures and densities to the OpenMC model; 3)~OpenMC solves for the nuclear heating; and 4)~Cardinal transfers the tally
values to the \texttt{MooseMesh} ``mirror.''

These steps continue until convergence criteria is achieved. In this work, we pursue verification of these multiphysics aspects
of Cardinal using a 1-D analytical benchmark from the Naval Nuclear Laboratories \cite{analytical_benchmark}.  This work does
not require \gls{cfd}, and thus NekRS will be left out of discussion from this point on.

The remainder of this paper is organized as follows. In Section \ref{sec:benchmark}, we summarize the analytical benchmark
modeled in this work. Section \ref{sec:model} then describes the Cardinal computational model of the benchmark. Section
\ref{sec:results} presents comparisons between Cardinal and the analytical benchmark. Finally, Section \ref{sec:conclusions}
presents conclusions and outlines ongoing and future efforts in the verification and validation of Cardinal.

\section{BENCHMARK PROBLEM DESCRIPTION}
\label{sec:benchmark}
The analytical benchmark is a coupling between three physics: $S_2$ neutron transport (with Doppler broadening), heat conduction,
and thermal expansion. $S_{2}$ transport restricts the neutron direction to only the $\pm x$ direction. A summary of the governing
equations and boundary conditions in the 1-D slab is shown in Fig. \ref{fig:slab_diagram}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\linewidth]{figures/1D_Benchmark_Diagram.png}
    \caption{This diagram summarizes the domain, governing ODEs, and boundary conditions for the slab.}
    \label{fig:slab_diagram}
\end{figure}

This benchmark uses a one-group assumption for the neutron cross-sections. As neutrons transport, heat from fission events deposit
volumetric power in the slab, causing thermal expansion and affecting the temperature distribution. In this benchmark, thermal
expansion is restricted to only the $x$-direction. This slab elongation feeds back neutronics and heat conduction by influencing
the domain length and material density. The slab has convective boundary conditions at the endpoints $x=\pm \frac{L}{2}$ with the
heat sink temperature $T_{0}$. The Doppler-broadened total microscopic cross-section follows an inverse-root temperature relationship,
\begin{equation}
    \sigma_{t}(T) = \sigma_{t,0}\sqrt{\frac{T_{0}}{T(x)}}
\end{equation}
Due to thermal expansion, the slab density varies as
\begin{equation} \label{sec:intro:density}
    \rho(x) =  \rho_{0} \sqrt{\frac{T_{0}}{T(x)}},
\end{equation}
This gives a Doppler-broadened, macroscopic total cross-section that accounts for changes in density due to temperature as
\begin{equation} \label{sec:intro:doppler}
    \Sigma_{t}(x) = \frac{\rho_{0}\sigma_{t,0} N_{A}}{A} \frac{T_{0}}{T(x)} = \Sigma_{t,0}\frac{T_{0}}{T(x)} ,
\end{equation}
where $ \sigma_{t,0}$ is the total microscopic cross-section at $T_{0}$, $N_{A}$ is Avogadro's number, and $A$ is the mass number
of the medium. The conduction equation governs heat flow in the slab and can be described in terms of the thermal conductivity
$\kappa(T)$,the energy released per fission $q$, the total macroscopic cross-section $\Sigma_{t}$, and the neutron flux $\phi$.
\begin{equation}
     \frac{d}{dx}\bigg[\kappa(T(x))\frac{dT(x)}{dx}\bigg] + q \Sigma_{t}(x)\phi(x) = 0.
\end{equation}
The main assumption used to craft the analytical solution is that $T(x)=f\phi(x)$. This assumption is held up by manipulating
the differential equations, inserting the cross-section temperature dependence, and matching coefficients so that the two ODEs
are of the same solution type. The matching of coefficients imposes two constraints that give equations for the total microscopic
cross-section $\sigma_{t,0}$ and the heat transfer coefficient $h$ in terms of the slab parameters. These are two key parameters
required as inputs for the simulation. For full details on the analytical solution's derivation, see \cite{analytical_benchmark}.

\section{COMPUTATIONAL MODEL}
\label{sec:model}
This section describes the OpenMC and \gls{moose} computational models, followed by the convergence criteria used for coupling.
Note that Cardinal currently does not yet support moving geometries in OpenMC. Instead of using thermo-mechanics for thermal
expansion, the simulation uses the formula for equilibrium length $L$ from \cite{analytical_benchmark} that accounts for all
three physics effects. The change in density due to temperature is accounted for in this simulation by using the total macroscopic
cross-section\ --\ which absorbs density to become a $\frac{1}{T}$ dependence\ --\ from (\ref{sec:intro:doppler}), as was
mentioned in Section \ref{sec:benchmark}.

\subsection{OpenMC Model}
The geometry used in OpenMC must be finite, despite the benchmark being infinite in the $y$ and $z$ directions. In general,
reflective boundary conditions can be used to simulate infinite dimensions. Thus, this benchmark can be represented with
vacuum boundary conditions at $x=\pm \frac{L}{2}$ and reflective boundary conditions at the $y$ and $z$ boundaries. Note that
particles only move in the $\pm x$ direction, so no $y$ or $z$ boundaries could be crossed, but with different scattering than
$S_{2}$, the reflective boundaries would come into play. Additionally, the $y$ and $z$ dimensions need to be set to $1$
in order for Equation (19) from the benchmark to uphold its one dimensional power integral, i.e. integration in $y$ and $z$ is
implied to contribute a factor of 1. \cite{analytical_benchmark} Fig. \ref{fig:slab_diagram} shows a diagram of the $1D$ geometry,
governing equations, and boundary conditions for the different physics.

The benchmark's one-group assumption was satisfied using OpenMC's multigroup mode, as opposed to typical continuous energy
transport. OpenMC allows user-defined cross-sections with the \texttt{XSdata} class. The cross-section for each reaction was
specified at an array of temperatures and was exported to a library allowing a look-up to determine the cross-section in each
region as temperature changes from iteration to iteration.

The OpenMC model required slight source code modifications to accommodate $S_2$-like transport. In typical OpenMC simulations,
the physics of each reaction describes the scattering dynamics. The Monte Carlo algorithm is agnostic to the direction
particles move, but it is not typically constrained to a discrete directional distribution. However, when modeling this
benchmark, any history with a particle moving perpendicular to the $x$-direction would attenuate particles in less
$x$-distance than if particles were constrained to either $\pm x$. To address this, we first use OpenMC's \texttt{PolarAzimuthal}
distribution to restrict the birth direction of particles to the $\pm x$ direction. We then also modified OpenMC in a
patched branch to mimic $S_{2}$ transport in two ways. First, when determining the angular cosine of scattering events,
$\mu$, particles either continue forward ($\mu=1$) or are back-scattered ($\mu=-1$) with equal probability, as opposed to
sampling the reaction physics for $\mu$. Second, since the simulation uses $k$-eigenvalue mode, neutrons born in subsequent
generations of the simulation also need to have their angular distributions restricted to $\pm x$. \textbf{Additional details on
the OpenMC model will be presented in the full paper.}
\begin{itemize}
    \item talk about generation of xs library
    \item talk about tallies required and why
    \item TBD move convergence discussion of batching here?
\end{itemize}

\subsection{MOOSE Heat Conduction Model}
The \gls{moose} \gls{hcm} is used to solve for thermal heat conduction within the slab. It solves the conduction equation
\begin{equation}\label{eq:conduction}
    - \nabla \cdot (k_{s}(\mathbf{r},T_{s}) \nabla T_{s}(\mathbf{r})) = \dot{q}_{s},
\end{equation}
using the \gls{fem} available in \gls{moose}. It uses a \texttt{HeatConductionMaterial} to specify that the thermal conductivity
obeys the benchmark's temperature dependence $\kappa(T)=\kappa_{0}T$. The boundary conditions used by \gls{moose} match temperature
boundary condition in red shown in Fig (\ref{fig:slab_diagram}). The \gls{hcm} is coupled to OpenMC by receiving the heat source in
each element from the tally and during each iteration, it recomputes the temperature distribution, sending it back to OpenMC for the
next transport solve.

\subsection{Convergence Criteria}
There are two types of convergence criteria used in this benchmark. The first type of convergence criteria relates to the
constituent iterations of single physics solves: neutronics and heat conduction. Monte Carlo is not an iterative method,
so batching settings are required before the simulation. The k-eigenvalue simulation used 50,000 particles per batch,
with 50 inactive batches and 100 active batches for every case. Additionally, the Robbins-Monro relaxation also contributed
to increasing the number of histories included in the flux statistics. While flux is typically reported with an uncertainty,
Cardinal does not currently support computing the uncertainty for cases using relaxation; though, an analytical solution for
flux is given. With this, the true error can be computed, as opposed to a statistical uncertainty which is typically reported.
The heat conduction, however, relies on MOOSE's iterative FEM solver. The convergence criteria for heat conduction is given by

\begin{lstlisting}
  nl_abs_tol = 1e-7
  nl_rel_tol = 1e-9
  petsc_options_iname = '-pc_type -pc_hypre_type'
  petsc_options_value = 'hypre boomeramg'
\end{lstlisting}
The second type of convergence relates to global iterations, i.e. Picard Iterations. Since this is a steady-state problem being
run with a transient solver, MOOSE's steady state detection feature was turned on. The steady state tolerance selected was $1e-5$.
\textbf{explain how the SS tolerance works i.e. L2 norm. Discuss what was included}. This led to increasing number of iterations
to achieve steady state as the mesh refined. Below is a figure showing this relationship.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{figures/its_to_ss.png}
    \caption{This plot shows the iterations required for \gls{moose} to detect steady state for each mesh size with log scale.}
    \label{fig:its_to_ss}
\end{figure}

\section{RESULTS}\label{sec:results}
The main results to compare with the benchmark are the temperature distribution, flux distribution, and eigenvalue. The benchmark provides
analytical solutions for all of these quantities An example distribution is shown in the figure below for the 50 mesh element case.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.45\linewidth]{figures/temp_50.png}
    \caption{This plot shows the computed temperature for 50 mesh elements.}
    \label{fig:temp50}
\end{figure}
In order to assess the accuracy of the temperature solution and verify that refining the mesh increases the accuracy, the analytical solution
was used to compute an $L_{2}$ error norm for temperature. The error computed, $\epsilon$, is given by
\begin{equation}
    \epsilon = \frac{|| T_{a} - T_{x} ||_{2}}{|| T_{a} ||_{2}},
\end{equation}
where $T_{a}$ is the analytical solution evaluated at the x-centroid of the mesh element and $T_{x}$ is the temperature computed for that
voxel from the multiphysics simulation. The figure below shows how this error relates to the number of mesh elements
\begin{figure}[H]
    \centering
    \includegraphics[width=0.55\linewidth]{figures/error_study.png}
    \caption{This plot shows log of the number of mesh elements vs the log of the $L_{2}$ error norm for the computed vs analytical temperature.}
    \label{fig:error_study}
\end{figure}
Linear convergence is achieved, as the slope of the line on the $\log(N)$ vs $\log(\epsilon)$ plot is $-0.99768235$.
\textbf{TODO should I mention deviation from} \href{https://mooseframework.inl.gov/getting_started/examples_and_tutorials/tutorial03_verification/step02_fem_convergence.html}{FEM moose}? Probably due to MC?
\textbf{TODO compute flux error norm like temp}
Lastly, the eigenvalue for each mesh is reported in the table below.

\begin{table}[H]
    \centering
    \caption{Eigenvalue with uncertainty for each mesh size.}
    \begin{tabular}{c|c}
        \textbf{mesh elements} & $k_{eff}$ \\
        \hline
        50 & 0.29550 $\pm$ 0.00012 \\
        100 & 0.29545 $\pm$ 0.00014 \\
        250 & 0.29585  $\pm$ 0.00011 \\
        500 & 0.29567 $\pm$ 0.00011 \\
        1000 & 0.29561 $\pm$ 0.00012
    \end{tabular}
    \label{tab:data}
\end{table}


\section{CONCLUSIONS}\label{sec:conclusions}

\begin{itemize}
    \item TODO comment on error trend.
    \item TODO comment on temperature and flux distributions matching well.
\end{itemize}


\section{CONCLUSIONS}


\section*{NOMENCLATURE}

% TODO fix glossary
\printglossary[title={Nomenclature}, nonumberlist, nopostdot]

\section*{ACKNOWLEDGEMENTS}
The authors would like to thank the OpenMC and MOOSE development teams for their guidance in model setup and assistance
with software. We also want to thank Dr. Griesheimer and Dr. Kooreman for their modeling advice and knowledge about the
analytical benchmark.

\setlength{\baselineskip}{12pt}
\bibliographystyle{mc2023}
\bibliography{mc2023}
\setlength{\baselineskip}{12pt}


\end{document}
